<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description"
        content="PetMarket - Tienda online para productos de mascotas. Envios rapidos, productos de calidad y atencion personalizada.">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="/css/header.css">
    <link rel="stylesheet" href="/css/footer.css">
    <link rel="stylesheet" href="/css/assets.css">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/buttons.css">
    <link rel="icon" href="/Imagenes/HuellaPerro.png">
    <title>PetMarket</title>
</head>

<body class="container py-4">

    <h1 class="mb-4">Gestión de Facturas</h1>

    <!-- Botón para generar factura desde el carrito -->
    <button id="btnCrearFactura" class="btn btn-success mb-3">Generar Factura desde Carrito</button>
    <div id="alertaFactura" class="mt-3"></div>

    <!-- Tabla de facturas -->
    <table class="table table-striped">
        <thead>
            <tr>
                <th>ID</th>
                <th>Usuario</th>
                <th>Subtotal</th>
                <th>IVA</th>
                <th>Total</th>
                <th>Fecha</th>
            </tr>
        </thead>
        <tbody id="facturasTabla">
            <!-- Aquí se insertan las facturas dinámicamente -->
        </tbody>
    </table>

    <script>
        // Cargar facturas al iniciar la página
        async function cargarFacturas() {
            try {
                const res = await fetch('/facturas/api');
                if (!res.ok) throw new Error("No se pudieron cargar las facturas");

                const data = await res.json();
                const facturasTabla = document.getElementById('facturasTabla');
                facturasTabla.innerHTML = '';

                data.forEach(f => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
            <td>${f._id}</td>
            <td>${f.user?.nombre || f.user || 'N/A'}</td>
            <td>$${f.subtotal.toFixed(2)}</td>
            <td>$${f.iva.toFixed(2)}</td>
            <td>$${f.total.toFixed(2)}</td>
            <td>${new Date(f.createdAt).toLocaleString()}</td>
          `;
                    facturasTabla.appendChild(tr);
                });
            } catch (error) {
                console.error("Error cargando facturas:", error);
            }
        }

        // Generar factura desde carrito
        document.getElementById('btnCrearFactura').addEventListener('click', async () => {
            const alerta = document.getElementById('alertaFactura');
            alerta.innerHTML = '';
            try {
                const res = await fetch('/facturas/api', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: { 'Accept': 'application/json' }
                });

                if (!res.ok) {
                    const errData = await res.json().catch(() => ({}));
                    throw new Error(errData.mensaje || 'Error al generar factura');
                }

                alerta.innerHTML = '<div class="alert alert-success">Factura generada correctamente desde carrito.</div>';
                cargarFacturas();
            } catch (err) {
                alerta.innerHTML = '<div class="alert alert-danger">' + err.message + '</div>';
            }
        });

        // Ejecutar carga inicial
        cargarFacturas();
    </script>

</body>

</html>