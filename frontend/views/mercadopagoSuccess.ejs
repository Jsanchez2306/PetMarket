<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pago Exitoso - PetMarket</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Estilos de PetMarket -->
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/header.css">
    <link rel="stylesheet" href="/css/footer.css">
    <link rel="stylesheet" href="/css/buttons.css">
    <link rel="stylesheet" href="/css/assets.css">
    <link rel="stylesheet" href="/css/mercadopago.css">
</head>

<body>
    <%- include('partials/headerUnificado') %>

    <main class="container my-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="success-container text-center">
                    <div>
                        <i class="fas fa-check-circle success-icon"></i>
                        <h1 class="display-4 mb-3">¡Pago Exitoso!</h1>
                        <p class="lead">Tu compra ha sido procesada correctamente con Mercado Pago</p>
                        
                        <% if (typeof paymentId !== 'undefined' && paymentId) { %>
                            <div class="payment-details">
                                <h5><i class="fas fa-credit-card"></i> Detalles del Pago</h5>
                                <p><strong>ID de Pago:</strong> <%= paymentId %></p>
                                <% if (typeof status !== 'undefined' && status) { %>
                                    <p><strong>Estado:</strong> 
                                        <span class="badge bg-success"><%= status %></span>
                                    </p>
                                <% } %>
                                <% if (typeof reference !== 'undefined' && reference) { %>
                                    <p><strong>Referencia:</strong> <%= reference %></p>
                                <% } %>
                                <% if (typeof totalCompra !== 'undefined' && totalCompra > 0) { %>
                                    <p><strong>Total Pagado:</strong> 
                                        <span class="text-success fw-bold">$<%= Number(totalCompra).toLocaleString('es-CO') %></span>
                                    </p>
                                <% } %>
                            </div>
                        <% } %>
                    </div>
                </div>

                <!-- Productos Comprados -->
                <% if (typeof productosComprados !== 'undefined' && productosComprados.length > 0) { %>
                <div class="card mt-4 border-0 shadow">
                    <div class="card-body">
                        <h5 class="card-title mb-4">
                            <i class="fas fa-shopping-bag text-success"></i> 
                            Resumen de tu Compra
                        </h5>
                        
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Producto</th>
                                        <th>Cantidad</th>
                                        <th>Precio Unit.</th>
                                        <th>Subtotal</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% productosComprados.forEach(producto => { %>
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <% if (producto.imagen) { %>
                                                <img src="<%= producto.imagen %>" alt="<%= producto.nombre %>" 
                                                     class="me-3" style="width: 50px; height: 50px; object-fit: cover; border-radius: 8px;">
                                                <% } else { %>
                                                <div class="me-3 bg-light d-flex align-items-center justify-content-center" 
                                                     style="width: 50px; height: 50px; border-radius: 8px;">
                                                    <i class="fas fa-box text-secondary"></i>
                                                </div>
                                                <% } %>
                                                <strong><%= producto.nombre %></strong>
                                            </div>
                                        </td>
                                        <td><%= producto.cantidad %></td>
                                        <td>$<%= Number(producto.precio).toLocaleString('es-CO') %></td>
                                        <td><strong>$<%= Number(producto.subtotal).toLocaleString('es-CO') %></strong></td>
                                    </tr>
                                    <% }); %>
                                </tbody>
                                <tfoot>
                                    <tr class="table-success">
                                        <th colspan="3" class="text-end">Total Pagado:</th>
                                        <th>$<%= Number(totalCompra).toLocaleString('es-CO') %></th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
                <% } %>

                <div class="card mt-4 border-0 shadow">
                    <div class="card-body text-center">
                        <h5 class="card-title mb-4">
                            <i class="fas fa-info-circle text-primary"></i> 
                            ¿Qué sigue ahora?
                        </h5>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <i class="fas fa-envelope text-success fs-1 mb-2"></i>
                                <h6>Confirmación por Email</h6>
                                <small class="text-muted">
                                    <% if (typeof usuario !== 'undefined' && usuario && usuario.email) { %>
                                        ✅ Factura enviada a <strong><%= usuario.email %></strong>
                                    <% } else { %>
                                        Recibirás un correo con los detalles de tu pedido y la factura
                                    <% } %>
                                </small>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <i class="fas fa-box text-warning fs-1 mb-2"></i>
                                <h6>Preparación</h6>
                                <small class="text-muted">
                                    Empezaremos a preparar tu pedido inmediatamente
                                </small>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <i class="fas fa-shipping-fast text-info fs-1 mb-2"></i>
                                <h6>Envío</h6>
                                <small class="text-muted">
                                    Te notificaremos cuando tu pedido esté en camino
                                </small>
                            </div>
                        </div>

                        <div class="mt-4">
                            <a href="/productos/catalogo" class="btn btn-primary me-3">
                                <i class="fas fa-shopping-bag"></i> Seguir Comprando
                            </a>
                            <a href="/carrito" class="btn btn-success me-3">
                                <i class="fas fa-shopping-cart"></i> Ver Carrito Vacío
                            </a>
                            <a href="/panel" class="btn btn-outline-secondary">
                                <i class="fas fa-user"></i> Mi Cuenta
                            </a>
                        </div>
                    </div>
                </div>

                <div class="alert alert-success mt-4">
                    <i class="fas fa-shield-alt"></i>
                    <strong>Pago Seguro:</strong> Tu pago fue procesado de forma segura a través de Mercado Pago.
                    Conserva el ID de pago para cualquier consulta.
                </div>

                <% if (typeof usuario !== 'undefined' && usuario && usuario.email) { %>
                <div class="alert alert-info mt-3">
                    <i class="fas fa-envelope me-2"></i>
                    <strong>Factura Enviada:</strong> Hemos enviado tu factura detallada por correo electrónico a 
                    <strong><%= usuario.email %></strong>. Revisa tu bandeja de entrada y spam.
                </div>
                <% } %>
            </div>
        </div>
    </main>

    <%- include('partials/footer') %>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Scripts de PetMarket -->
    <script src="/js/headerUnificado.js"></script>
    <script src="/js/modales.js"></script>
    <script>
        // Limpiar carrito del localStorage y actualizar contador
        document.addEventListener('DOMContentLoaded', function() {
            // Limpiar el carrito del localStorage ya que el pago fue exitoso
            localStorage.removeItem('carrito');
            
            // Actualizar contador del carrito inmediatamente
            const cartBadge = document.querySelector('.cart-badge');
            if (cartBadge) {
                cartBadge.textContent = '0';
                cartBadge.style.display = 'none';
            }
            
            // Disparar evento personalizado para que otros scripts sepan que el carrito está vacío
            window.dispatchEvent(new CustomEvent('carritoVaciado', { 
                detail: { origen: 'pagoExitoso' } 
            }));
        });
    </script>
</body>
</html>